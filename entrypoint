#!/bin/bash
# Copyright (C) 2021 Leandro Lisboa Penz <lpenz@lpenz.org>
# This file is subject to the terms and conditions defined in
# file 'LICENSE', which is part of this source code package.

if [ -n "$INPUT_DEPENDENCIES_DEBIAN" ]; then
    function install_dependencies {
        su - -c "apt-get update && apt-get install --no-install-recommends -y $INPUT_DEPENDENCIES_DEBIAN"
    }
else
    function install_dependencies {
        : no Debian packages to install
    }
fi

OUTPUT_PATH=lcov.info

set -e -x

install_dependencies

export CARGO_INCREMENTAL='0'
export RUSTFLAGS='-Zinstrument-coverage -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests'
export RUSTDOCFLAGS='-Zinstrument-coverage -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests -Z unstable-options --persist-doctests target/debug/doctestbins'
export LLVM_PROFILE_FILE="coverage-%p-%m.profraw"
export RUST_BACKTRACE=1

cargo test --all-features --no-fail-fast

grcov . \
      -s . \
      --binary-path ./target/debug/ \
      --ignore "/*" --ignore "../*" \
      --branch --ignore-not-existing \
      -o "$OUTPUT_PATH"
echo "::set-output name=report::$OUTPUT_PATH"

